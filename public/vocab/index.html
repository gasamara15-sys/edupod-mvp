<script>
document.addEventListener("DOMContentLoaded", () => {
  const DEBUG = false; // ← 운영에서는 false
  const list = document.getElementById("list");
  const q = document.getElementById("q");
  let data = [];

  // /vocab로 접근 시 /vocab/로 정규화(상대경로 꼬임 방지)
  if (location.pathname.endsWith('/vocab') && !location.pathname.endsWith('/vocab/')) {
    location.replace(location.pathname + '/');
    return; // 리다이렉트 후 종료
  }

  // 1) 동일 도메인 고정 경로  2) 현재 경로 보정  3) raw 폴백(화면에는 비표시)
  const sources = [
    `${location.origin}/vocab/frequency/top100.json`,
    `${location.origin}${(location.pathname.endsWith('/') ? location.pathname : location.pathname + '/') }frequency/top100.json`,
    "https://raw.githubusercontent.com/gasamara15-sys/edupod-mvp/main/public/vocab/frequency/top100.json"
  ].map(u => `${u}?v=${Date.now()}`); // 캐시 버스팅

  function render(arr){
    if (!arr.length) {
      list.innerHTML = `<p style="color:#666">표시할 항목이 없습니다.</p>`;
      return;
    }
    list.innerHTML = arr.map(x => `
      <div class="card">
        <div class="rank">${x.rank}. ${x.word} <span class="muted">(${x.partOfSpeech || ""})</span></div>
        <div>${x.meaning || ""}</div>
        <div class="muted">${x.example_en || ""}</div>
        <div>${x.example_ko || ""}</div>
      </div>
    `).join("");
  }

  function showError(msg) {
    list.innerHTML = `<p class="err">데이터를 불러오지 못했습니다.</p>`;
    if (DEBUG) {
      // 개발 중에만 콘솔로 자세한 원인 확인
      console.error(msg);
    }
  }

  async function fetchFirst(urls){
    for (const u of urls) {
      try {
        const r = await fetch(u, { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status} @ ${u}`);
        if (DEBUG) console.log("loaded:", u);
        return await r.json();
      } catch (e) {
        if (DEBUG) console.warn("fail:", e.message);
      }
    }
    throw new Error("all sources failed");
  }

  fetchFirst(sources)
    .then(json => { data = json; render(json); })
    .catch(err => showError(err.message));

  q.addEventListener("input", () => {
    const v = q.value.trim().toLowerCase();
    const filtered = !v ? data : data.filter(
      x =>
        (x.word||"").toLowerCase().includes(v) ||
        (x.meaning||"").toLowerCase().includes(v) ||
        (x.example_en||"").toLowerCase().includes(v)
    );
    render(filtered);
  });
});
</script>
